<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù‡Ù„Ø§ ÙÙˆØ¯ | Ø§Ù„ÙƒØ§Ø´ÙŠØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-input { padding: 15px; border-radius: 12px; border: none; text-align: center; font-size: 1.2rem; width: 260px; margin-bottom: 15px; }
        .login-btn { padding: 10px 40px; background: #00b894; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; border-bottom: 4px solid #00b894; }
        .order-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-right: 6px solid #00b894; }
        .order-id { font-weight: 800; color: #00b894; }
        .print-btn { background: #00b894; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; text-align: center; }
            .receipt-box { width: 80mm; margin: 0 auto; border: 1px solid #000; padding: 5mm; text-align: right; direction: rtl; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h2 style="color:white; margin-bottom:20px;">ğŸ”’ Ù†Ø¸Ø§Ù… Ù…Ø·Ø¹Ù… Ù‡Ù„Ø§ ÙÙˆØ¯</h2>
        <input type="password" id="adminPass" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„">
        <button onclick="checkPass()" class="login-btn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        <p id="errorMsg" style="color:#ff7675; margin-top:15px; display:none;">Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­</p>
    </div>

    <div class="dashboard-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-utensils fa-2x" style="color:#00b894;"></i>
            <h2>Ù‡Ù„Ø§ ÙÙˆØ¯ | Hala Food</h2>
        </div>
        <button onclick="fetchOrders()" style="background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <div id="ordersContainer"></div>
    <div id="printSection" class="printable-area"></div>

<script>
        // ğŸ”´ ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø·ÙˆÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby1elvhQB0-svU-_H5xh2jrWtTfOeRRiCmGdrXo0RAzM32SfsfJ0t5yOeKSvZE29SY6Xg/exec';
        
        const SECRET_PASS = "654321"; // Ø±Ù…Ø² Ù‡Ù„Ø§ ÙÙˆØ¯

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²
        function checkPass() {
            const input = document.getElementById('adminPass').value;
            if(input === SECRET_PASS) {
                document.getElementById('loginOverlay').style.display = 'none';
                sessionStorage.setItem('isHalaAdmin', 'true'); // Ø­ÙØ¸ Ø§Ù„Ø¯Ø®ÙˆÙ„
                fetchOrders();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø²Ø± Enter Ù„Ù„Ø³Ø±Ø¹Ø©
        document.getElementById("adminPass").addEventListener("keypress", function(event) {
            if (event.key === "Enter") checkPass();
        });

        // âœ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            if(sessionStorage.getItem('isHalaAdmin') === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
                fetchOrders();
            }
        };

        function fetchOrders() {
            const container = document.getElementById('ordersContainer');
            fetch(GOOGLE_SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = '';
                // ÙÙ„ØªØ±Ø© Ù‡Ù„Ø§ ÙÙˆØ¯
                const halaOrders = data.filter(order => order.items.includes('Ù‡Ù„Ø§') || order.items.includes('Hala'));
                
                if(halaOrders.length === 0) {
                    container.innerHTML = '<p style="text-align:center; margin-top:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
                    return;
                }

                halaOrders.forEach((order, index) => {
                    let allItems = order.items.split(' | ');
                    let vendorTotal = 0;
                    let cleanItems = [];

                    allItems.forEach(item => {
                        if(item.includes('Ù‡Ù„Ø§') || item.includes('Hala')) {
                            let match = item.match(/\{(\d+)\}/);
                            let price = match ? parseInt(match[1]) : 0;
                            vendorTotal += price;
                            let cleanText = item.replace(/\{(\d+)\}/, '').trim();
                            cleanItems.push(cleanText);
                        }
                    });

                    if(vendorTotal === 0) vendorTotal = parseInt(order.total); 

                    container.innerHTML += `
                        <div class="order-card">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <span class="order-id">#Ø·Ù„Ø¨_Ù‡Ù„Ø§_${index+1}</span>
                                <span style="font-size:0.8rem;">${new Date(order.time).toLocaleTimeString('ar-IQ')}</span>
                            </div>
                            <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">
                                ${cleanItems.join('<br>')}
                            </div>
                            <div style="background:#f0f2f5; padding:10px; border-radius:8px;">
                                ğŸ’µ <b>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø¹Ù…: ${vendorTotal.toLocaleString()} Ø¯.Ø¹</b>
                            </div>
                            <div style="margin-top:10px;">
                                <button class="print-btn" onclick='printHala(${JSON.stringify(order)}, ${JSON.stringify(cleanItems)}, ${vendorTotal})'>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</button>
                            </div>
                        </div>`;
                });
            });
        }

        function printHala(order, cleanItems, vendorTotal) {
            let itemsHTML = cleanItems.map(i => `<div>- ${i}</div>`).join('');
            document.getElementById('printSection').innerHTML = `
                <div class="receipt-box">
                    <h3>Ù…Ø·Ø¹Ù… Ù‡Ù„Ø§ ÙÙˆØ¯ ğŸ•</h3>
                    <hr>
                    <div>${new Date(order.time).toLocaleDateString('ar-IQ')}</div>
                    <div>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${order.region}</div>
                    <hr>
                    ${itemsHTML}
                    <hr>
                    <div style="font-weight:bold; font-size:1.2rem;">Ø­Ø³Ø§Ø¨Ù†Ø§: ${vendorTotal.toLocaleString()} Ø¯.Ø¹</div>
                    </div>`;
            window.print();
        }
        
        // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(function(){
            if(sessionStorage.getItem('isHalaAdmin') === 'true') fetchOrders();
        }, 30000);
    </script>
</body>
</html>